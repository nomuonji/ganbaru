name: å¤œã®å‹•ç”»æŠ•ç¨¿

on:
  schedule:
    # æ¯æ—¥ JST 19:00 (UTC 10:00) ã«å®Ÿè¡Œ
    - cron: '0 10 * * *'
  workflow_dispatch:

permissions:
  contents: write

env:
  TZ: Asia/Tokyo

jobs:
  post-night-video:
    runs-on: ubuntu-latest
    
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra
          fc-cache -fv

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: ç’°å¢ƒå¤‰æ•°è¨­å®š
        run: |
          echo "YOUTUBE_CLIENT_ID=${{ secrets.YOUTUBE_CLIENT_ID }}" >> .env
          echo "YOUTUBE_CLIENT_SECRET=${{ secrets.YOUTUBE_CLIENT_SECRET }}" >> .env
          echo "YOUTUBE_REFRESH_TOKEN=${{ secrets.YOUTUBE_REFRESH_TOKEN }}" >> .env
          echo "OUTPUT_DIR=./output" >> .env

      - name: å¤œã®å‹•ç”»ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        run: npm run render:night

      - name: YouTubeã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        id: upload
        run: npm run upload:youtube -- --type night

      - name: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆ
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/video-status.json
          git diff --staged --quiet || git commit -m "ğŸ“¹ Update video status: night $(date +%Y-%m-%d)"
          git push
