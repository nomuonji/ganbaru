name: ã¾ã¨ã‚å‹•ç”»æŠ•ç¨¿

on:
  schedule:
    # æ¯æ—¥ JST 23:30 (UTC 14:30) ã«å®Ÿè¡Œ
    - cron: '30 14 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  post-summary-video:
    runs-on: ubuntu-latest
    
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: ç’°å¢ƒå¤‰æ•°è¨­å®š
        run: |
          echo "YOUTUBE_CLIENT_ID=${{ secrets.YOUTUBE_CLIENT_ID }}" >> .env
          echo "YOUTUBE_CLIENT_SECRET=${{ secrets.YOUTUBE_CLIENT_SECRET }}" >> .env
          echo "YOUTUBE_REFRESH_TOKEN=${{ secrets.YOUTUBE_REFRESH_TOKEN }}" >> .env
          echo "OUTPUT_DIR=./output" >> .env

      - name: ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
        run: npm run fetch:comments

      - name: ã¾ã¨ã‚å‹•ç”»ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        run: npm run render:summary

      - name: YouTubeã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        run: npm run upload:youtube -- --type summary

      - name: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆ
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/video-status.json
          git diff --staged --quiet || git commit -m "ğŸ“¹ Update video status: summary $(date +%Y-%m-%d)"
          git push

      - name: ã‚³ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        uses: actions/upload-artifact@v4
        with:
          name: summary-data
          path: |
            output/comments_*.json
            output/summary_*.mp4
